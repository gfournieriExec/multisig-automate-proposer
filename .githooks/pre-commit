#!/bin/sh

# Pre-commit script to ensure the action is built before commits

echo "ğŸ” Running pre-commit checks for GitHub Action..."

# Check if we're in a git repository
if ! git rev-parse --is-inside-work-tree > /dev/null 2>&1; then
    echo "âŒ Not in a git repository"
    exit 1
fi

# Check if action files have been modified
if git diff --cached --name-only | grep -E "(action\.yml|action/|package\.json|tsconfig\.json)" > /dev/null; then
    echo "ğŸ“¦ Action files modified, rebuilding..."
    
    # Install dependencies if node_modules doesn't exist
    if [ ! -d "node_modules" ]; then
        echo "ğŸ“¥ Installing dependencies..."
        npm ci
    fi
    
    # Run linting
    echo "ğŸ§¹ Running linter..."
    npm run lint:fix
    
    # Run type checking
    echo "ğŸ” Type checking..."
    npm run typecheck
    
    # Build the action
    echo "ğŸ—ï¸ Building action..."
    npm run build
    
    # Check if dist files were generated
    if [ ! -f "dist/action/main.js" ]; then
        echo "âŒ Build failed - dist/action/main.js not found"
        exit 1
    fi
    
    # Add the built files to the commit
    git add dist/
    
    echo "âœ… Action built successfully and added to commit"
else
    echo "â„¹ï¸ No action files modified, skipping build"
fi

echo "âœ… Pre-commit checks passed"
